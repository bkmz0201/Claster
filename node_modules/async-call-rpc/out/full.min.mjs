var e;let r=e=>"string"==typeof e,t=e=>"boolean"==typeof e,n=e=>"function"==typeof e,o=e=>"object"==typeof e&&null!==e,i="Error",l=void 0,{setPrototypeOf:a}=Object,s=e=>Promise.resolve(e),{isArray:c}=Array,{apply:u}=Reflect,f={serialization:e=>e,deserialization:e=>e},y=(e=[l,l],r,t="null")=>({serialization(n){if(t&&o(n)&&"result"in n&&n.result===l){let e={...n};e.result=null,"keep"===t&&(e.undef=!0),n=e}return JSON.stringify(n,e[0],r)},deserialization(r){let t=JSON.parse(r,e[1]);return o(t)&&"result"in t&&null===t.result&&"undef"in t&&!0===t.undef&&(t.result=l,delete t.undef),t}});function p({keepUndefined:e="null",replacer:r,reviver:t,space:n}={}){return{encode:t=>(e&&(c(t)?t.forEach(d):d(t)),JSON.stringify(t,r,n)),decode:e=>JSON.parse(e,t)}}let d=e=>{"result"in e&&e.result===l&&(e.result=null)};(e=p||(p={})).Default=e();let h="AsyncCall/",b=Symbol.for(h+"ignored"),g=Symbol.for(h+"notify"),w=Symbol.for(h+"batch");function m(e){return n(e)?e[g]:new Proxy(e,{get:P})}let P=(e,r)=>e[r][g];function E(e){let t=[],n={__proto__:new Proxy({},{get(o,i){let l=(...r)=>e[w](t,i,...r);return l[g]=(...r)=>e[w][g](t,i,...r),l[g][g]=l[g],r(i)&&Object.defineProperty(n,i,{value:l,configurable:!0}),l}})};return[new Proxy(n,{getPrototypeOf:()=>null,setPrototypeOf:(e,r)=>null===r}),()=>{t.length&&t.r[0](),t.length=0},(e=Error("Aborted"))=>{t.length&&t.r[1](e),t.length=0}]}function O(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}class v extends Error{constructor(e,r,t,n){super(r),O(this,"name",void 0),O(this,"code",void 0),O(this,"stack",void 0),this.name=e,this.code=t,this.stack=n}}let $={},k={},S={},j={},x=[$,k,S,j],_=(e,r)=>{let t=x.indexOf(e);return r.message+=`Error ${t}: https://github.com/Jack-Works/async-call-rpc/wiki/Errors#`+t,r},N={__proto__:null,Error,EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError},z="DOMException:",A=(e,r,t,n)=>{try{let o;if(e.startsWith(z)&&(o=M())){let t=e.slice(z.length);return new o(r,t)}if(!(e in N))return new v(e,r,t,n);{let o=new N[e](r);return o.stack=n,o.code=t,o}}catch(o){return Error(`E${t} ${e}: ${r}
${n}`)}},T=e=>(e+"").replace(/^.+\n.+\n/,""),M=()=>{try{return DOMException}catch(e){}};function R(e,r){e&&e.addEventListener("abort",r,{once:!0})}let C=(e,r,t,n)=>{let o={jsonrpc:"2.0",id:e,method:r,params:t,remoteStack:n};return B(o,"id"),H(o,"remoteStack"),o},D=(e,r)=>{let t={jsonrpc:"2.0",id:e,result:r};return B(t,"id"),t},J=(e,r,t,n)=>{e===l&&(e=null),Number.isNaN(r=Math.floor(r))&&(r=-1);let o={jsonrpc:"2.0",id:e,error:{code:r,message:t,data:n}};return B(o.error,"data"),o},I=(e,r)=>{let t=L({},e,r),n=t.error;return n.code=-32700,n.message="Parse error",t},W=e=>J(e,-32600,"Invalid Request"),q=e=>J(e,-32601,"Method not found"),L=(e,r,t)=>{let{id:n}=e,{code:o,message:i,data:l}=t(r,e);return J(n,o,i,l)},F=(e="",r=-1)=>t=>{let o=U("",()=>t.message),l=U(i,(e=t.constructor)=>n(e)&&e.name),a=M();a&&t instanceof a&&(l=z+t.name);let s=typeof t;return("string"==s||"number"===s||"boolean"==s||"bigint"==s)&&(l=i,o=t+""),{code:r,message:o,data:e?{stack:e,type:l}:{type:l}}},G=e=>{if(!o(e)||!("jsonrpc"in e)||"2.0"!==e.jsonrpc)return!1;if("params"in e){let r=e.params;if(!c(r)&&!o(r))return!1}return!0},U=(e,r)=>{try{let t=r();if(t===l)return e;return t+""}catch(r){return e}},B=(e,r)=>{e[r]===l&&delete e[r]},H=(e,r)=>{e[r]||delete e[r]},K=()=>Math.random().toString(36).slice(2),Q=e=>void 0===e||e,V=e=>{if("all"===e)return[!0,!0,!0,!0,!0,!0];if(!t(e)){let{beCalled:r,localError:t,remoteError:n,type:o,requestReplay:i,sendLocalStack:l}=e;return[Q(r),Q(t),Q(n),"basic"!==o,i,l]}return e?[!0,!0,!0,!0]:[]},X=e=>{if(!t(e)){let{methodNotFound:r,unknownMessage:t}=e;return[r,t]}return[e,e]};function Y(e,t){let a,f,y,p,d=!0,h=async()=>{try{a=await e}catch(e){f=e,eO("AsyncCall failed to start",e)}finally{d=!1}},m=e=>(y=e,ee(e)&&e.setup((e,r)=>eN(e,r).then(ez),(e,r)=>{let t=ey(e,r);return!!G(t)||s(t).then(G)}),Z(e)&&e.on&&e.on((r,t)=>eN(r,t).then(ez).then(r=>r&&e.send(r))),e),{serializer:P,encoder:E,key:O,name:v,strict:$=!0,log:k=!0,parameterStructures:x,parameterStructure:N,preferLocalImplementation:z=!1,idGenerator:M=K,mapError:J,logger:U,channel:B,thenable:H,signal:Q,forceSignal:Y}=t;if(P&&E)throw TypeError("Please remove serializer.");if(v&&O)throw TypeError("Please remove key.");if(x&&N)throw TypeError("Please remove parameterStructure.");let er=x||N||"by-position",et=v||O||"rpc",en=()=>{Q&&Q.throwIfAborted(),Y&&Y.throwIfAborted()},{encode:eo,encodeRequest:ei,encodeResponse:el,decode:ea,decodeRequest:es,decodeResponse:ec}=E||{},eu=E?e=>u(ei||eo,E,[e]):P?e=>P.serialization(e):Object,ef=E?e=>u(el||eo,E,[e]):P?e=>P.serialization(e):Object,ey=E?(e,r)=>"request"==r?u(es||ea,E,[e]):"response"==r?u(ec||ea,E,[e]):u(ea,E,[e]):P?e=>P.deserialization(e):Object;e instanceof Promise?h():(a=e,d=!1);let[ep,ed]=X($),[eh,eb,eg,ew,em,eP]=V(k),{log:eE,error:eO=eE,debug:ev=eE,groupCollapsed:e$=eE,groupEnd:ek=eE,warn:eS=eE}=U||console,ej=new Map;R(Y,()=>{ej.forEach(e=>e[1](Y.reason)),ej.clear()});let ex=async e=>{if(Q&&Q.aborted||Y&&Y.aborted)return eA(Q&&Q.reason||Y&&Y.reason,"",e);if(d)await h();else if(f)return eA(f,"",e);let r="";try{let{params:t,method:o,id:i,remoteStack:l}=e,s=o.startsWith("rpc.")?Symbol.for(o):o,f=a&&a[s];if(!n(f)){if(ep)return q(i);eb&&ev("Missing method",s,e);return}let y=c(t)?t:[t];r=T(Error().stack);let p=new Promise(e=>e(u(f,a,y)));if(eh){if(ew){let e=[`${et}.%c${o}%c(${y.map(()=>"%o").join(", ")}%c)
%o %c@${i}`,"color:#d2c057","",...y,"",p,"color:gray;font-style:italic;"];if(em){let r=()=>{debugger;return u(f,a,y)};e.push(()=>r())}l?(e$(...e),eE(l),ek()):eE(...e)}else eE(`${et}.${o}(${[...y].toString()}) @${i}`)}let d=await p;if(d===b)return;return D(i,d)}catch(t){return eA(t,r,e)}},e_=async e=>{let t="",n="",a=0,s=i;if("error"in e){let l=e.error;t=l.message,a=l.code;let c=l.data;n=o(c)&&"stack"in c&&r(c.stack)?c.stack:"<remote stack not available>",s=o(c)&&"type"in c&&r(c.type)?c.type:i,eg&&(ew?eO(`${s}: ${t}(${a}) %c@${e.id}
%c${n}`,"color: gray",""):eO(`${s}: ${t}(${a}) @${e.id}
${n}`))}let{id:c}=e;if(null===c||c===l||!ej.has(c))return;let[u,f,y=""]=ej.get(c);ej.delete(c),"error"in e?f(A(s,t,a,n+"\n    Ð°t AsyncCall (rpc) \n"+y)):u(e.result)},eN=async(e,r)=>{let t;let n=l;try{if(t=await ey(e,r),G(t))return n=await eR(t);if(c(t)&&t.every(G)&&0!==t.length)return Promise.all(t.map(eR));if(!ed)return l;{let e=t.id;return e===l&&(e=null),W(e)}}catch(r){let e;eb&&eO(r,t,n);try{e=""+r.stack}catch(e){}return I(r,J||F(e))}},ez=async e=>{if(e){if(!c(e))return ef(e);{let r=e.filter(e=>e&&"id"in e);if(0===r.length)return;return ef(r)}}};B instanceof Promise?p=B.then(m):m(B);let eA=(e,r,t)=>(o(e)&&"stack"in e&&(e.stack=r.split("\n").reduce((e,r)=>e.replace(r+"\n",""),""+e.stack)),eb&&eO(e),L(t,e,J||F(eP?e.stack:l))),eT=async(e,r)=>{r&&(e=[...e]);let t=await eu(e);return(y||await p).send(t)},eM=(e,r)=>{for(let t of e)if("id"in t){let e=ej.get(t.id);e&&e[1](r)}},eR=async e=>"method"in e?"id"in e?Y?new Promise((r,t)=>{let n=()=>r(eA(Y.reason,"",e));ex(e).then(r,t).finally(()=>Y.removeEventListener("abort",n)),R(Y,n)}):ex(e):void ex(e).catch(()=>{}):e_(e),eC=(e,t,i,s=!1)=>new Promise((c,u)=>{en();let f=l;if(e===w&&(f=t.shift(),e=t.shift()),"symbol"==typeof e){let r=Symbol.keyFor(e)||e.description;if(r){if(r.startsWith("rpc."))e=r;else throw TypeError("Not start with rpc.")}}else if(e.startsWith("rpc."))throw _(S,TypeError());if(z&&!d&&r(e)){let r=a&&a[e];if(n(r))return c(r(...t))}let y=M();i=T(i);let p="by-name"===er&&1===t.length&&o(t[0])?t[0]:t,h=C(s?l:y,e,p,eP?i:l);if(f?(f.push(h),f.r||(f.r=[()=>eT(f,!0),e=>eM(f,e)])):eT(h).catch(u),s)return c();ej.set(y,[c,u,i])}),eD=(e,t)=>{let n={[t]:(...e)=>eC(t,e,Error().stack)}[t],o={[t]:(...e)=>eC(t,e,Error().stack,!0)}[t];return n[g]=o[g]=o,r(t)&&Object.defineProperty(eJ,t,{value:n,configurable:!0}),n},eJ={__proto__:new Proxy({},{get:eD})};return!1===H?eJ.then=l:H===l&&Object.defineProperty(eJ,"then",{configurable:!0,get(){eS(_(j,TypeError("RPC used as Promise: ")))}}),new Proxy(eJ,{getPrototypeOf:()=>null,setPrototypeOf:(e,r)=>null===r,getOwnPropertyDescriptor:(e,r)=>(r in eJ||eD(e,r),Object.getOwnPropertyDescriptor(eJ,r))})}let Z=e=>"send"in e&&n(e.send),ee=e=>"setup"in e&&n(e.setup);function er(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}let et="rpc.async-iterator.",en=Symbol.for(et+"start"),eo=Symbol.for(et+"next"),ei=Symbol.for(et+"return"),el=Symbol.for(et+"throw");function ea(e,t){var o;if(!ec){let e=async function*(){};a(es,(ec=e.constructor).prototype);let r=Object.getPrototypeOf(e());a(es.prototype,r)}let i=new Map,[l]=X(null===(o=t.strict)||void 0===o||o),{idGenerator:s=K}=t,c=(e,r)=>{let t=i.get(e);if(!t){if(!l)return b;throw _($,Error(`Iterator ${e}, `))}let n=r(t);return eu(n,()=>i.delete(e)),n},u=Y({async [en](r,t){let o=(await e)[r];if(!n(o)){if(!l)return b;throw TypeError(r+" is not a function")}let a=o(...t),c=s();return i.set(c,a),c},[eo]:(e,r)=>c(e,e=>e.next(r)),[ei]:(e,r)=>c(e,e=>n(e.return)&&e.return(r)),[el]:(e,r)=>c(e,e=>n(e.throw)&&e.throw(r))},t),f=(e,t)=>{if(!r(t))throw _(k,TypeError(""));let n={[t]:(...e)=>{let r=u[en](t,e);return new es(u,r)}}[t];return Object.defineProperty(y,t,{value:n,configurable:!0}),n},y={__proto__:new Proxy({},{get:f})};return new Proxy(y,{getPrototypeOf:()=>null,setPrototypeOf:(e,r)=>null===r,getOwnPropertyDescriptor:(e,r)=>(r in y||f(e,r),Object.getOwnPropertyDescriptor(y,r))})}class es{async return(e){return this.d?ef(!0,e):this.c(this.r[ei](await this.i,e))}async next(e){return this.d?ef(!0):this.c(this.r[eo](await this.i,e))}async throw(e){if(!this.d)return this.c(this.r[el](await this.i,e));throw e}constructor(e,r){er(this,"r",void 0),er(this,"i",void 0),er(this,"d",void 0),er(this,"c",void 0),this.r=e,this.i=r,this.d=!1,this.c=async e=>(await eu(e,()=>this.d=!0),e)}}let ec=!1,eu=async(e,r)=>{try{let t=await e;t&&t.done&&r()}catch(e){}},ef=(e,r)=>({done:e,value:r});export{Y as AsyncCall,ea as AsyncGeneratorCall,p as JSONEncoder,y as JSONSerialization,f as NoSerialization,E as batch,m as notify};
//# sourceMappingURL=full.min.mjs.map
