var e;let r=e=>"string"==typeof e,t=e=>"boolean"==typeof e,n=e=>"function"==typeof e,o=e=>"object"==typeof e&&null!==e,i="Error",l=void 0,a=e=>Promise.resolve(e),{isArray:s}=Array,{apply:c}=Reflect,u={serialization:e=>e,deserialization:e=>e},f=(e=[l,l],r,t="null")=>({serialization(n){if(t&&o(n)&&"result"in n&&n.result===l){let e={...n};e.result=null,"keep"===t&&(e.undef=!0),n=e}return JSON.stringify(n,e[0],r)},deserialization(r){let t=JSON.parse(r,e[1]);return o(t)&&"result"in t&&null===t.result&&"undef"in t&&!0===t.undef&&(t.result=l,delete t.undef),t}});function d({keepUndefined:e="null",replacer:r,reviver:t,space:n}={}){return{encode:t=>(e&&(s(t)?t.forEach(p):p(t)),JSON.stringify(t,r,n)),decode:e=>JSON.parse(e,t)}}let p=e=>{"result"in e&&e.result===l&&(e.result=null)};(e=d||(d={})).Default=e();let y="AsyncCall/",h=Symbol.for(y+"ignored"),g=Symbol.for(y+"notify"),b=Symbol.for(y+"batch");function m(e){return n(e)?e[g]:new Proxy(e,{get:w})}let w=(e,r)=>e[r][g];function E(e){let t=[],n={__proto__:new Proxy({},{get(o,i){let l=(...r)=>e[b](t,i,...r);return l[g]=(...r)=>e[b][g](t,i,...r),l[g][g]=l[g],r(i)&&Object.defineProperty(n,i,{value:l,configurable:!0}),l}})};return[new Proxy(n,{getPrototypeOf:()=>null,setPrototypeOf:(e,r)=>null===r}),()=>{t.length&&t.r[0](),t.length=0},(e=Error("Aborted"))=>{t.length&&t.r[1](e),t.length=0}]}function P(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}class k extends Error{constructor(e,r,t,n){super(r),P(this,"name",void 0),P(this,"code",void 0),P(this,"stack",void 0),this.name=e,this.code=t,this.stack=n}}let O={},$={},v=[{},{},O,$],S=(e,r)=>{let t=v.indexOf(e);return r.message+=`Error ${t}: https://github.com/Jack-Works/async-call-rpc/wiki/Errors#`+t,r},j={__proto__:null,Error,EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError},_="DOMException:",x=(e,r,t,n)=>{try{let o;if(e.startsWith(_)&&(o=z())){let t=e.slice(_.length);return new o(r,t)}if(!(e in j))return new k(e,r,t,n);{let o=new j[e](r);return o.stack=n,o.code=t,o}}catch(o){return Error(`E${t} ${e}: ${r}
${n}`)}},N=e=>(e+"").replace(/^.+\n.+\n/,""),z=()=>{try{return DOMException}catch(e){}};function A(e,r){e&&e.addEventListener("abort",r,{once:!0})}let R=(e,r,t,n)=>{let o={jsonrpc:"2.0",id:e,method:r,params:t,remoteStack:n};return F(o,"id"),U(o,"remoteStack"),o},J=(e,r)=>{let t={jsonrpc:"2.0",id:e,result:r};return F(t,"id"),t},M=(e,r,t,n)=>{e===l&&(e=null),Number.isNaN(r=Math.floor(r))&&(r=-1);let o={jsonrpc:"2.0",id:e,error:{code:r,message:t,data:n}};return F(o.error,"data"),o},T=(e,r)=>{let t=W({},e,r),n=t.error;return n.code=-32700,n.message="Parse error",t},C=e=>M(e,-32600,"Invalid Request"),D=e=>M(e,-32601,"Method not found"),W=(e,r,t)=>{let{id:n}=e,{code:o,message:i,data:l}=t(r,e);return M(n,o,i,l)},I=(e="",r=-1)=>t=>{let o=L("",()=>t.message),l=L(i,(e=t.constructor)=>n(e)&&e.name),a=z();a&&t instanceof a&&(l=_+t.name);let s=typeof t;return("string"==s||"number"===s||"boolean"==s||"bigint"==s)&&(l=i,o=t+""),{code:r,message:o,data:e?{stack:e,type:l}:{type:l}}},q=e=>{if(!o(e)||!("jsonrpc"in e)||"2.0"!==e.jsonrpc)return!1;if("params"in e){let r=e.params;if(!s(r)&&!o(r))return!1}return!0},L=(e,r)=>{try{let t=r();if(t===l)return e;return t+""}catch(r){return e}},F=(e,r)=>{e[r]===l&&delete e[r]},U=(e,r)=>{e[r]||delete e[r]},B=()=>Math.random().toString(36).slice(2),G=e=>void 0===e||e,H=e=>{if("all"===e)return[!0,!0,!0,!0,!0,!0];if(!t(e)){let{beCalled:r,localError:t,remoteError:n,type:o,requestReplay:i,sendLocalStack:l}=e;return[G(r),G(t),G(n),"basic"!==o,i,l]}return e?[!0,!0,!0,!0]:[]},K=e=>{if(!t(e)){let{methodNotFound:r,unknownMessage:t}=e;return[r,t]}return[e,e]};function Q(e,t){let u,f,d,p,y=!0,m=async()=>{try{u=await e}catch(e){f=e,ek("AsyncCall failed to start",e)}finally{y=!1}},w=e=>(d=e,X(e)&&e.setup((e,r)=>eN(e,r).then(ez),(e,r)=>{let t=ed(e,r);return!!q(t)||a(t).then(q)}),V(e)&&e.on&&e.on((r,t)=>eN(r,t).then(ez).then(r=>r&&e.send(r))),e),{serializer:E,encoder:P,key:k,name:v,strict:j=!0,log:_=!0,parameterStructures:z,parameterStructure:M,preferLocalImplementation:L=!1,idGenerator:F=B,mapError:U,logger:G,channel:Q,thenable:Y,signal:Z,forceSignal:ee}=t;if(E&&P)throw TypeError("Please remove serializer.");if(v&&k)throw TypeError("Please remove key.");if(z&&M)throw TypeError("Please remove parameterStructure.");let er=z||M||"by-position",et=v||k||"rpc",en=()=>{Z&&Z.throwIfAborted(),ee&&ee.throwIfAborted()},{encode:eo,encodeRequest:ei,encodeResponse:el,decode:ea,decodeRequest:es,decodeResponse:ec}=P||{},eu=P?e=>c(ei||eo,P,[e]):E?e=>E.serialization(e):Object,ef=P?e=>c(el||eo,P,[e]):E?e=>E.serialization(e):Object,ed=P?(e,r)=>"request"==r?c(es||ea,P,[e]):"response"==r?c(ec||ea,P,[e]):c(ea,P,[e]):E?e=>E.deserialization(e):Object;e instanceof Promise?m():(u=e,y=!1);let[ep,ey]=K(j),[eh,eg,eb,em,ew,eE]=H(_),{log:eP,error:ek=eP,debug:eO=eP,groupCollapsed:e$=eP,groupEnd:ev=eP,warn:eS=eP}=G||console,ej=new Map;A(ee,()=>{ej.forEach(e=>e[1](ee.reason)),ej.clear()});let e_=async e=>{if(Z&&Z.aborted||ee&&ee.aborted)return eA(Z&&Z.reason||ee&&ee.reason,"",e);if(y)await m();else if(f)return eA(f,"",e);let r="";try{let{params:t,method:o,id:i,remoteStack:l}=e,a=o.startsWith("rpc.")?Symbol.for(o):o,f=u&&u[a];if(!n(f)){if(ep)return D(i);eg&&eO("Missing method",a,e);return}let d=s(t)?t:[t];r=N(Error().stack);let p=new Promise(e=>e(c(f,u,d)));if(eh){if(em){let e=[`${et}.%c${o}%c(${d.map(()=>"%o").join(", ")}%c)
%o %c@${i}`,"color:#d2c057","",...d,"",p,"color:gray;font-style:italic;"];if(ew){let r=()=>{debugger;return c(f,u,d)};e.push(()=>r())}l?(e$(...e),eP(l),ev()):eP(...e)}else eP(`${et}.${o}(${[...d].toString()}) @${i}`)}let y=await p;if(y===h)return;return J(i,y)}catch(t){return eA(t,r,e)}},ex=async e=>{let t="",n="",a=0,s=i;if("error"in e){let l=e.error;t=l.message,a=l.code;let c=l.data;n=o(c)&&"stack"in c&&r(c.stack)?c.stack:"<remote stack not available>",s=o(c)&&"type"in c&&r(c.type)?c.type:i,eb&&(em?ek(`${s}: ${t}(${a}) %c@${e.id}
%c${n}`,"color: gray",""):ek(`${s}: ${t}(${a}) @${e.id}
${n}`))}let{id:c}=e;if(null===c||c===l||!ej.has(c))return;let[u,f,d=""]=ej.get(c);ej.delete(c),"error"in e?f(x(s,t,a,n+"\n    Ð°t AsyncCall (rpc) \n"+d)):u(e.result)},eN=async(e,r)=>{let t;let n=l;try{if(t=await ed(e,r),q(t))return n=await eM(t);if(s(t)&&t.every(q)&&0!==t.length)return Promise.all(t.map(eM));if(!ey)return l;{let e=t.id;return e===l&&(e=null),C(e)}}catch(r){let e;eg&&ek(r,t,n);try{e=""+r.stack}catch(e){}return T(r,U||I(e))}},ez=async e=>{if(e){if(!s(e))return ef(e);{let r=e.filter(e=>e&&"id"in e);if(0===r.length)return;return ef(r)}}};Q instanceof Promise?p=Q.then(w):w(Q);let eA=(e,r,t)=>(o(e)&&"stack"in e&&(e.stack=r.split("\n").reduce((e,r)=>e.replace(r+"\n",""),""+e.stack)),eg&&ek(e),W(t,e,U||I(eE?e.stack:l))),eR=async(e,r)=>{r&&(e=[...e]);let t=await eu(e);return(d||await p).send(t)},eJ=(e,r)=>{for(let t of e)if("id"in t){let e=ej.get(t.id);e&&e[1](r)}},eM=async e=>"method"in e?"id"in e?ee?new Promise((r,t)=>{let n=()=>r(eA(ee.reason,"",e));e_(e).then(r,t).finally(()=>ee.removeEventListener("abort",n)),A(ee,n)}):e_(e):void e_(e).catch(()=>{}):ex(e),eT=(e,t,i,a=!1)=>new Promise((s,c)=>{en();let f=l;if(e===b&&(f=t.shift(),e=t.shift()),"symbol"==typeof e){let r=Symbol.keyFor(e)||e.description;if(r){if(r.startsWith("rpc."))e=r;else throw TypeError("Not start with rpc.")}}else if(e.startsWith("rpc."))throw S(O,TypeError());if(L&&!y&&r(e)){let r=u&&u[e];if(n(r))return s(r(...t))}let d=F();i=N(i);let p="by-name"===er&&1===t.length&&o(t[0])?t[0]:t,h=R(a?l:d,e,p,eE?i:l);if(f?(f.push(h),f.r||(f.r=[()=>eR(f,!0),e=>eJ(f,e)])):eR(h).catch(c),a)return s();ej.set(d,[s,c,i])}),eC=(e,t)=>{let n={[t]:(...e)=>eT(t,e,Error().stack)}[t],o={[t]:(...e)=>eT(t,e,Error().stack,!0)}[t];return n[g]=o[g]=o,r(t)&&Object.defineProperty(eD,t,{value:n,configurable:!0}),n},eD={__proto__:new Proxy({},{get:eC})};return!1===Y?eD.then=l:Y===l&&Object.defineProperty(eD,"then",{configurable:!0,get(){eS(S($,TypeError("RPC used as Promise: ")))}}),new Proxy(eD,{getPrototypeOf:()=>null,setPrototypeOf:(e,r)=>null===r,getOwnPropertyDescriptor:(e,r)=>(r in eD||eC(e,r),Object.getOwnPropertyDescriptor(eD,r))})}let V=e=>"send"in e&&n(e.send),X=e=>"setup"in e&&n(e.setup);export{Q as AsyncCall,d as JSONEncoder,f as JSONSerialization,u as NoSerialization,E as batch,m as notify};
//# sourceMappingURL=base.min.mjs.map
