!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).AsyncCall={})}(this,function(e){"use strict";var t;let r=e=>"string"==typeof e,n=e=>"boolean"==typeof e,o=e=>"function"==typeof e,i=e=>"object"==typeof e&&null!==e,l="Error",a=void 0,{setPrototypeOf:s}=Object,c=e=>Promise.resolve(e),{isArray:u}=Array,{apply:f}=Reflect;function y({keepUndefined:e="null",replacer:t,reviver:r,space:n}={}){return{encode:r=>(e&&(u(r)?r.forEach(d):d(r)),JSON.stringify(r,t,n)),decode:e=>JSON.parse(e,r)}}let d=e=>{"result"in e&&e.result===a&&(e.result=null)};(t=y||(y={})).Default=t();let p="AsyncCall/",h=Symbol.for(p+"ignored"),b=Symbol.for(p+"notify"),g=Symbol.for(p+"batch"),w=(e,t)=>e[t][b];function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class P extends Error{constructor(e,t,r,n){super(t),m(this,"name",void 0),m(this,"code",void 0),m(this,"stack",void 0),this.name=e,this.code=r,this.stack=n}}let E={},O={},v={},$={},k=[E,O,v,$],S=(e,t)=>{let r=k.indexOf(e);return t.message+=`Error ${r}: https://github.com/Jack-Works/async-call-rpc/wiki/Errors#`+r,t},j={__proto__:null,Error,EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError},x="DOMException:",_=(e,t,r,n)=>{try{let o;if(e.startsWith(x)&&(o=T())){let r=e.slice(x.length);return new o(t,r)}if(!(e in j))return new P(e,t,r,n);{let o=new j[e](t);return o.stack=n,o.code=r,o}}catch(o){return Error(`E${r} ${e}: ${t}
${n}`)}},N=e=>(e+"").replace(/^.+\n.+\n/,""),T=()=>{try{return DOMException}catch(e){}};function z(e,t){e&&e.addEventListener("abort",t,{once:!0})}let A=(e,t,r,n)=>{let o={jsonrpc:"2.0",id:e,method:t,params:r,remoteStack:n};return F(o,"id"),G(o,"remoteStack"),o},C=(e,t)=>{let r={jsonrpc:"2.0",id:e,result:t};return F(r,"id"),r},M=(e,t,r,n)=>{e===a&&(e=null),Number.isNaN(t=Math.floor(t))&&(t=-1);let o={jsonrpc:"2.0",id:e,error:{code:t,message:r,data:n}};return F(o.error,"data"),o},R=(e,t)=>{let r=I({},e,t),n=r.error;return n.code=-32700,n.message="Parse error",r},D=e=>M(e,-32600,"Invalid Request"),J=e=>M(e,-32601,"Method not found"),I=(e,t,r)=>{let{id:n}=e,{code:o,message:i,data:l}=r(t,e);return M(n,o,i,l)},W=(e="",t=-1)=>r=>{let n=L("",()=>r.message),i=L(l,(e=r.constructor)=>o(e)&&e.name),a=T();a&&r instanceof a&&(i=x+r.name);let s=typeof r;return("string"==s||"number"===s||"boolean"==s||"bigint"==s)&&(i=l,n=r+""),{code:t,message:n,data:e?{stack:e,type:i}:{type:i}}},q=e=>{if(!i(e)||!("jsonrpc"in e)||"2.0"!==e.jsonrpc)return!1;if("params"in e){let t=e.params;if(!u(t)&&!i(t))return!1}return!0},L=(e,t)=>{try{let r=t();if(r===a)return e;return r+""}catch(t){return e}},F=(e,t)=>{e[t]===a&&delete e[t]},G=(e,t)=>{e[t]||delete e[t]},U=()=>Math.random().toString(36).slice(2),B=e=>void 0===e||e,H=e=>{if("all"===e)return[!0,!0,!0,!0,!0,!0];if(!n(e)){let{beCalled:t,localError:r,remoteError:n,type:o,requestReplay:i,sendLocalStack:l}=e;return[B(t),B(r),B(n),"basic"!==o,i,l]}return e?[!0,!0,!0,!0]:[]},K=e=>{if(!n(e)){let{methodNotFound:t,unknownMessage:r}=e;return[t,r]}return[e,e]};function Q(e,t){let n,s,y,d,p=!0,w=async()=>{try{n=await e}catch(e){s=e,eO("AsyncCall failed to start",e)}finally{p=!1}},m=e=>(y=e,X(e)&&e.setup((e,t)=>eN(e,t).then(eT),(e,t)=>{let r=ey(e,t);return!!q(r)||c(r).then(q)}),V(e)&&e.on&&e.on((t,r)=>eN(t,r).then(eT).then(t=>t&&e.send(t))),e),{serializer:P,encoder:E,key:O,name:k,strict:j=!0,log:x=!0,parameterStructures:T,parameterStructure:M,preferLocalImplementation:L=!1,idGenerator:F=U,mapError:G,logger:B,channel:Q,thenable:Y,signal:Z,forceSignal:ee}=t;if(P&&E)throw TypeError("Please remove serializer.");if(k&&O)throw TypeError("Please remove key.");if(T&&M)throw TypeError("Please remove parameterStructure.");let et=T||M||"by-position",er=k||O||"rpc",en=()=>{Z&&Z.throwIfAborted(),ee&&ee.throwIfAborted()},{encode:eo,encodeRequest:ei,encodeResponse:el,decode:ea,decodeRequest:es,decodeResponse:ec}=E||{},eu=E?e=>f(ei||eo,E,[e]):P?e=>P.serialization(e):Object,ef=E?e=>f(el||eo,E,[e]):P?e=>P.serialization(e):Object,ey=E?(e,t)=>"request"==t?f(es||ea,E,[e]):"response"==t?f(ec||ea,E,[e]):f(ea,E,[e]):P?e=>P.deserialization(e):Object;e instanceof Promise?w():(n=e,p=!1);let[ed,ep]=K(j),[eh,eb,eg,ew,em,eP]=H(x),{log:eE,error:eO=eE,debug:ev=eE,groupCollapsed:e$=eE,groupEnd:ek=eE,warn:eS=eE}=B||console,ej=new Map;z(ee,()=>{ej.forEach(e=>e[1](ee.reason)),ej.clear()});let ex=async e=>{if(Z&&Z.aborted||ee&&ee.aborted)return ez(Z&&Z.reason||ee&&ee.reason,"",e);if(p)await w();else if(s)return ez(s,"",e);let t="";try{let{params:r,method:i,id:l,remoteStack:a}=e,s=i.startsWith("rpc.")?Symbol.for(i):i,c=n&&n[s];if(!o(c)){if(ed)return J(l);eb&&ev("Missing method",s,e);return}let y=u(r)?r:[r];t=N(Error().stack);let d=new Promise(e=>e(f(c,n,y)));if(eh){if(ew){let e=[`${er}.%c${i}%c(${y.map(()=>"%o").join(", ")}%c)
%o %c@${l}`,"color:#d2c057","",...y,"",d,"color:gray;font-style:italic;"];if(em){let t=()=>{debugger;return f(c,n,y)};e.push(()=>t())}a?(e$(...e),eE(a),ek()):eE(...e)}else eE(`${er}.${i}(${[...y].toString()}) @${l}`)}let p=await d;if(p===h)return;return C(l,p)}catch(r){return ez(r,t,e)}},e_=async e=>{let t="",n="",o=0,s=l;if("error"in e){let a=e.error;t=a.message,o=a.code;let c=a.data;n=i(c)&&"stack"in c&&r(c.stack)?c.stack:"<remote stack not available>",s=i(c)&&"type"in c&&r(c.type)?c.type:l,eg&&(ew?eO(`${s}: ${t}(${o}) %c@${e.id}
%c${n}`,"color: gray",""):eO(`${s}: ${t}(${o}) @${e.id}
${n}`))}let{id:c}=e;if(null===c||c===a||!ej.has(c))return;let[u,f,y=""]=ej.get(c);ej.delete(c),"error"in e?f(_(s,t,o,n+"\n    Ð°t AsyncCall (rpc) \n"+y)):u(e.result)},eN=async(e,t)=>{let r;let n=a;try{if(r=await ey(e,t),q(r))return n=await eM(r);if(u(r)&&r.every(q)&&0!==r.length)return Promise.all(r.map(eM));if(!ep)return a;{let e=r.id;return e===a&&(e=null),D(e)}}catch(t){let e;eb&&eO(t,r,n);try{e=""+t.stack}catch(e){}return R(t,G||W(e))}},eT=async e=>{if(e){if(!u(e))return ef(e);{let t=e.filter(e=>e&&"id"in e);if(0===t.length)return;return ef(t)}}};Q instanceof Promise?d=Q.then(m):m(Q);let ez=(e,t,r)=>(i(e)&&"stack"in e&&(e.stack=t.split("\n").reduce((e,t)=>e.replace(t+"\n",""),""+e.stack)),eb&&eO(e),I(r,e,G||W(eP?e.stack:a))),eA=async(e,t)=>{t&&(e=[...e]);let r=await eu(e);return(y||await d).send(r)},eC=(e,t)=>{for(let r of e)if("id"in r){let e=ej.get(r.id);e&&e[1](t)}},eM=async e=>"method"in e?"id"in e?ee?new Promise((t,r)=>{let n=()=>t(ez(ee.reason,"",e));ex(e).then(t,r).finally(()=>ee.removeEventListener("abort",n)),z(ee,n)}):ex(e):void ex(e).catch(()=>{}):e_(e),eR=(e,t,l,s=!1)=>new Promise((c,u)=>{en();let f=a;if(e===g&&(f=t.shift(),e=t.shift()),"symbol"==typeof e){let t=Symbol.keyFor(e)||e.description;if(t){if(t.startsWith("rpc."))e=t;else throw TypeError("Not start with rpc.")}}else if(e.startsWith("rpc."))throw S(v,TypeError());if(L&&!p&&r(e)){let r=n&&n[e];if(o(r))return c(r(...t))}let y=F();l=N(l);let d="by-name"===et&&1===t.length&&i(t[0])?t[0]:t,h=A(s?a:y,e,d,eP?l:a);if(f?(f.push(h),f.r||(f.r=[()=>eA(f,!0),e=>eC(f,e)])):eA(h).catch(u),s)return c();ej.set(y,[c,u,l])}),eD=(e,t)=>{let n={[t]:(...e)=>eR(t,e,Error().stack)}[t],o={[t]:(...e)=>eR(t,e,Error().stack,!0)}[t];return n[b]=o[b]=o,r(t)&&Object.defineProperty(eJ,t,{value:n,configurable:!0}),n},eJ={__proto__:new Proxy({},{get:eD})};return!1===Y?eJ.then=a:Y===a&&Object.defineProperty(eJ,"then",{configurable:!0,get(){eS(S($,TypeError("RPC used as Promise: ")))}}),new Proxy(eJ,{getPrototypeOf:()=>null,setPrototypeOf:(e,t)=>null===t,getOwnPropertyDescriptor:(e,t)=>(t in eJ||eD(e,t),Object.getOwnPropertyDescriptor(eJ,t))})}let V=e=>"send"in e&&o(e.send),X=e=>"setup"in e&&o(e.setup);function Y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let Z="rpc.async-iterator.",ee=Symbol.for(Z+"start"),et=Symbol.for(Z+"next"),er=Symbol.for(Z+"return"),en=Symbol.for(Z+"throw");class eo{async return(e){return this.d?ea(!0,e):this.c(this.r[er](await this.i,e))}async next(e){return this.d?ea(!0):this.c(this.r[et](await this.i,e))}async throw(e){if(!this.d)return this.c(this.r[en](await this.i,e));throw e}constructor(e,t){Y(this,"r",void 0),Y(this,"i",void 0),Y(this,"d",void 0),Y(this,"c",void 0),this.r=e,this.i=t,this.d=!1,this.c=async e=>(await el(e,()=>this.d=!0),e)}}let ei=!1,el=async(e,t)=>{try{let r=await e;r&&r.done&&t()}catch(e){}},ea=(e,t)=>({done:e,value:t});e.AsyncCall=Q,e.AsyncGeneratorCall=function(e,t){var n;if(!ei){let e=async function*(){};s(eo,(ei=e.constructor).prototype);let t=Object.getPrototypeOf(e());s(eo.prototype,t)}let i=new Map,[l]=K(null===(n=t.strict)||void 0===n||n),{idGenerator:a=U}=t,c=(e,t)=>{let r=i.get(e);if(!r){if(!l)return h;throw S(E,Error(`Iterator ${e}, `))}let n=t(r);return el(n,()=>i.delete(e)),n},u=Q({async [ee](t,r){let n=(await e)[t];if(!o(n)){if(!l)return h;throw TypeError(t+" is not a function")}let s=n(...r),c=a();return i.set(c,s),c},[et]:(e,t)=>c(e,e=>e.next(t)),[er]:(e,t)=>c(e,e=>o(e.return)&&e.return(t)),[en]:(e,t)=>c(e,e=>o(e.throw)&&e.throw(t))},t),f=(e,t)=>{if(!r(t))throw S(O,TypeError(""));let n={[t]:(...e)=>{let r=u[ee](t,e);return new eo(u,r)}}[t];return Object.defineProperty(y,t,{value:n,configurable:!0}),n},y={__proto__:new Proxy({},{get:f})};return new Proxy(y,{getPrototypeOf:()=>null,setPrototypeOf:(e,t)=>null===t,getOwnPropertyDescriptor:(e,t)=>(t in y||f(e,t),Object.getOwnPropertyDescriptor(y,t))})},e.JSONEncoder=y,e.JSONSerialization=(e=[a,a],t,r="null")=>({serialization(n){if(r&&i(n)&&"result"in n&&n.result===a){let e={...n};e.result=null,"keep"===r&&(e.undef=!0),n=e}return JSON.stringify(n,e[0],t)},deserialization(t){let r=JSON.parse(t,e[1]);return i(r)&&"result"in r&&null===r.result&&"undef"in r&&!0===r.undef&&(r.result=a,delete r.undef),r}}),e.NoSerialization={serialization:e=>e,deserialization:e=>e},e.batch=function(e){let t=[],n={__proto__:new Proxy({},{get(o,i){let l=(...r)=>e[g](t,i,...r);return l[b]=(...r)=>e[g][b](t,i,...r),l[b][b]=l[b],r(i)&&Object.defineProperty(n,i,{value:l,configurable:!0}),l}})};return[new Proxy(n,{getPrototypeOf:()=>null,setPrototypeOf:(e,t)=>null===t}),()=>{t.length&&t.r[0](),t.length=0},(e=Error("Aborted"))=>{t.length&&t.r[1](e),t.length=0}]},e.notify=function(e){return o(e)?e[b]:new Proxy(e,{get:w})}});
//# sourceMappingURL=full.min.js.map
