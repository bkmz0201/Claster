{"version":3,"file":"base.min.js","sources":["../src/utils/encoder.ts","../src/utils/constants.ts","../src/utils/internalSymbol.ts","../src/core/notify.ts","../src/utils/error.ts","../src/utils/jsonrpc.ts","../src/utils/generateRandomID.ts","../src/utils/normalizeOptions.ts","../src/Async-Call.ts","../src/utils/serialization.ts","../src/core/batch.ts"],"sourcesContent":["import type { IsomorphicEncoder, Request, Requests, Response, Responses, SuccessResponse } from '../types.ts'\nimport { isArray, undefined } from './constants.ts'\n\n/**\n * @public\n * Options of {@link (JSONEncoder:function)}\n */\nexport interface JSONEncoderOptions {\n    /** Adds indentation, white space, and line break characters to the return-value JSON text to make it easier to read. */\n    space?: string | number | undefined\n    /**\n     * How to handle `\"undefined\"` in the result of {@link SuccessResponse}.\n     *\n     * @remarks\n     * If you need a full support of encoding `undefined`, for example, when the result is `{ field: undefined }` and you want to keep it,\n     * you need to find another library to do this.\n     *\n     * If this is not handled properly, `JSON.stringify` will emit an invalid JSON-RPC object (fields with `undefined` value will be omitted).\n     *\n     * Options:\n     * - `\"null\"`(**default**): convert it to `null`.\n     * - `false`: do not do anything, let it break.\n     */\n    keepUndefined?: false | 'null' | undefined\n    /** A function that transforms the results. */\n    replacer?: ((this: any, key: string, value: any) => any) | undefined\n    /** A function that transforms the results. This function is called for each member of the object. If a member contains nested objects, the nested objects are transformed before the parent object is. */\n    reviver?: ((this: any, key: string, value: any) => any) | undefined\n}\n/**\n * Create a encoder by JSON.parse/stringify\n *\n * @public\n * @param options - Options for this encoder.\n * @remarks {@link IsomorphicEncoder}\n */\nexport function JSONEncoder({\n    keepUndefined = 'null',\n    replacer,\n    reviver,\n    space,\n}: JSONEncoderOptions = {}): IsomorphicEncoder {\n    return {\n        encode(data) {\n            if (keepUndefined) {\n                isArray(data) ? data.forEach(undefinedEncode) : undefinedEncode(data)\n            }\n            return JSON.stringify(data, replacer, space)\n        },\n        decode(encoded) {\n            const data: Requests | Responses = JSON.parse(encoded as string, reviver)\n            return data\n        },\n    }\n}\n\nconst undefinedEncode = (i: Response | Request) => {\n    if ('result' in i && i.result === undefined) {\n        i.result = null\n    }\n}\n\n/** @public */\nexport namespace JSONEncoder {\n    export const Default: IsomorphicEncoder<unknown, unknown> = JSONEncoder()\n}\n","export const isString = (x: unknown): x is string => typeof x === 'string'\nexport const isBoolean = (x: unknown): x is boolean => typeof x === 'boolean'\nexport const isFunction = (x: unknown): x is Function => typeof x === 'function'\nexport const isObject = (params: any): params is object => typeof params === 'object' && params !== null\nexport const ERROR = 'Error'\nexport const undefined = void 0\nexport const { setPrototypeOf } = Object\nexport const Promise_resolve = <T>(x: T) => Promise.resolve(x)\nexport const { isArray } = Array as { isArray(arg: any): arg is readonly any[] }\nexport const { apply } = Reflect\n","const i = 'AsyncCall/'\n// ! side effect\nexport const AsyncCallIgnoreResponse = Symbol.for(i + 'ignored')\nexport const AsyncCallNotify = Symbol.for(i + 'notify')\nexport const AsyncCallBatch = Symbol.for(i + 'batch')\n","import { AsyncCallNotify } from '../utils/internalSymbol.ts'\nimport { isFunction } from '../utils/constants.ts'\n\n/**\n * Make the returning type to `Promise<void>`\n * @internal\n * @remarks\n * Due to the limitation of TypeScript, generic signatures cannot be preserved\n * if the function is the top level parameter of this utility type,\n * or the function is not returning `Promise<void>`.\n */\nexport type _IgnoreResponse<T> = T extends (...args: infer Args) => unknown\n    ? (...args: Args) => Promise<void>\n    : {\n          [key in keyof T as T[key] extends Function ? key : never]: T[key] extends (\n              ...args: infer Args\n          ) => infer Return\n              ? Return extends Promise<void>\n                  ? T[key]\n                  : (...args: Args) => Promise<void>\n              : never\n      }\n/**\n * Wrap the AsyncCall instance to send notification.\n * @param instanceOrFnOnInstance - The AsyncCall instance or function on the AsyncCall instance\n * @example\n * const notifyOnly = notify(AsyncCall(...))\n * @public\n */\n\nexport function notify<T extends object>(instanceOrFnOnInstance: T): _IgnoreResponse<T> {\n    if (isFunction(instanceOrFnOnInstance)) return (instanceOrFnOnInstance as any)[AsyncCallNotify]\n    return new Proxy(instanceOrFnOnInstance, { get: notifyTrap }) as any\n}\nconst notifyTrap = (target: any, p: string | number | symbol) => {\n    return target[p][AsyncCallNotify]\n}\n","import type { AbortSignalLike } from '../types.ts'\n\nclass CustomError extends Error {\n    // TODO: support cause\n    constructor(\n        public name: string,\n        message: string,\n        public code: number,\n        public stack: string,\n    ) {\n        super(message)\n    }\n}\nexport const Err_Cannot_find_a_running_iterator_with_given_ID: unique symbol = {} as any\nexport const Err_Only_string_can_be_the_RPC_method_name: unique symbol = {} as any\nexport const Err_Cannot_call_method_starts_with_rpc_dot_directly: unique symbol = {} as any\nexport const Err_Then_is_accessed_on_local_implementation_Please_explicitly_mark_if_it_is_thenable_in_the_options: unique symbol =\n    {} as any\nconst Messages = [\n    Err_Cannot_find_a_running_iterator_with_given_ID,\n    Err_Only_string_can_be_the_RPC_method_name,\n    Err_Cannot_call_method_starts_with_rpc_dot_directly,\n    Err_Then_is_accessed_on_local_implementation_Please_explicitly_mark_if_it_is_thenable_in_the_options,\n] as const\n// https://github.com/Jack-Works/async-call-rpc/wiki/Error-messages\nexport const makeHostedMessage = (id: (typeof Messages)[number], error: Error) => {\n    const n = Messages.indexOf(id)\n    error.message += `Error ${n}: https://github.com/Jack-Works/async-call-rpc/wiki/Errors#` + n\n    return error\n}\n// ! side effect\n/** These Error is defined in ECMAScript spec */\nconst errors: Record<string, typeof EvalError> = {\n    // @ts-expect-error\n    __proto__: null,\n    Error,\n    EvalError,\n    RangeError,\n    ReferenceError,\n    SyntaxError,\n    TypeError,\n    URIError,\n}\nexport const DOMExceptionHeader = 'DOMException:'\n/**\n * AsyncCall support somehow transfer ECMAScript Error\n */\nexport const RecoverError = (type: string, message: string, code: number, stack: string): Error => {\n    try {\n        let E\n        if (type.startsWith(DOMExceptionHeader) && (E = globalDOMException())) {\n            const name = type.slice(DOMExceptionHeader.length)\n            return new E(message, name)\n        } else if (type in errors) {\n            const e = new errors[type]!(message)\n            e.stack = stack\n            // @ts-expect-error\n            e.code = code\n            return e\n        } else {\n            return new CustomError(type, message, code, stack)\n        }\n    } catch {\n        return new Error(`E${code} ${type}: ${message}\\n${stack}`)\n    }\n}\nexport const removeStackHeader = (stack: unknown) => String(stack).replace(/^.+\\n.+\\n/, '')\n// ! side effect\nexport const globalDOMException = (() => {\n    try {\n        // @ts-expect-error\n        return DOMException\n    } catch {}\n}) as () => DOMException | undefined\ntype DOMException = { new (message: string, name: string): any }\nexport function onAbort(signal: AbortSignalLike | undefined, callback: () => void) {\n    signal && signal.addEventListener('abort', callback, { once: true })\n}\n","import { globalDOMException as DOMException, DOMExceptionHeader } from './error.ts'\nimport type { ErrorMapFunction } from '../Async-Call.ts'\nimport { ERROR, isArray, isFunction, isObject, undefined } from './constants.ts'\nimport type { Request, SuccessResponse, ErrorResponse, ID, Response } from '../types.ts'\n\nexport const jsonrpc = '2.0'\nexport const makeRequest = (\n    id: ID,\n    method: string,\n    params: readonly unknown[] | object,\n    remoteStack?: string,\n): Request => {\n    const x: Request = { jsonrpc, id, method, params, remoteStack }\n    deleteUndefined(x, 'id')\n    deleteFalsy(x, 'remoteStack')\n    return x\n}\nexport const makeSuccessResponse = (id: ID, result: unknown): SuccessResponse => {\n    const x: SuccessResponse = { jsonrpc, id, result }\n    deleteUndefined(x, 'id')\n    return x\n}\nexport const makeErrorResponse = <T>(id: ID, code: number, message: string, data?: T): ErrorResponse<T> => {\n    if (id === undefined) id = null\n    code = Math.floor(code)\n    if (Number.isNaN(code)) code = -1\n    const x: ErrorResponse<T> = { jsonrpc, id, error: { code, message, data } }\n    deleteUndefined(x.error, 'data')\n    return x\n}\n// Pre defined error in section 5.1\n// ! side effect\nexport const ErrorResponseParseError = <T>(e: unknown, mapper: ErrorMapFunction<T>): ErrorResponse<T> => {\n    const obj = ErrorResponseMapped({} as any, e, mapper)\n    const o = obj.error as Mutable<ErrorResponse['error']>\n    o.code = -32700\n    o.message = 'Parse error'\n    return obj\n}\n\n// Not using.\n// InvalidParams -32602 'Invalid params'\n// InternalError -32603 'Internal error'\nexport const ErrorResponseInvalidRequest = (id: ID) => makeErrorResponse(id, -32600, 'Invalid Request')\nexport const ErrorResponseMethodNotFound = (id: ID) => makeErrorResponse(id, -32601, 'Method not found')\n\ntype AsyncCallErrorDetail = {\n    stack?: string\n    type?: string\n}\nexport const ErrorResponseMapped = <T>(request: Request, e: unknown, mapper: ErrorMapFunction<T>): ErrorResponse<T> => {\n    const { id } = request\n    const { code, message, data } = mapper(e, request)\n    return makeErrorResponse(id, code, message, data)\n}\n\nexport const defaultErrorMapper =\n    (stack = '', code = -1): ErrorMapFunction<AsyncCallErrorDetail> =>\n    (e) => {\n        let message = toString('', () => (e as any).message)\n        let type = toString(ERROR, (ctor = (e as any).constructor) => isFunction(ctor) && ctor.name)\n        const E = DOMException()\n        if (E && e instanceof E) type = DOMExceptionHeader + e.name\n        const eType = typeof e\n        if (eType == 'string' || eType === 'number' || eType == 'boolean' || eType == 'bigint') {\n            type = ERROR\n            message = String(e)\n        }\n        const data: AsyncCallErrorDetail = stack ? { stack, type } : { type }\n        return { code, message, data }\n    }\n\nexport const isJSONRPCObject = (data: any): data is Response | Request => {\n    if (!isObject(data)) return false\n    if (!('jsonrpc' in data)) return false\n    if (data.jsonrpc !== jsonrpc) return false\n    if ('params' in data) {\n        const params = data.params\n        if (!isArray(params) && !isObject(params)) return false\n    }\n    return true\n}\n\nconst toString = (_default: string, val: () => any) => {\n    try {\n        const v = val()\n        if (v === undefined) return _default\n        return String(v)\n    } catch {\n        return _default\n    }\n}\nconst deleteUndefined = <O>(x: O, key: keyof O) => {\n    if (x[key] === undefined) delete x[key]\n}\nconst deleteFalsy = <T>(x: T, key: keyof T) => {\n    if (!x[key]) delete x[key]\n}\ntype Mutable<T> = { -readonly [key in keyof T]: T[key] }\n","export const generateRandomID = () => Math.random().toString(36).slice(2)\n","import type { AsyncCallOptions } from '../Async-Call.ts'\nimport { isBoolean } from './constants.ts'\nconst undefinedToTrue = (x: undefined | boolean) => (x === void 0 ? true : x)\ntype NormalizedLogOptions = readonly [\n    beCalled: boolean,\n    localError: boolean,\n    remoteError: boolean,\n    isPretty?: boolean,\n    requestReplay?: boolean,\n    sendLocalStack?: boolean,\n]\n\nexport const normalizeLogOptions = (log: NonNullable<AsyncCallOptions['log']>): NormalizedLogOptions | [] => {\n    if (log === 'all') return [true, true, true, true, true, true]\n    if (!isBoolean(log)) {\n        const { beCalled, localError, remoteError, type, requestReplay, sendLocalStack } = log\n        return [\n            undefinedToTrue(beCalled),\n            undefinedToTrue(localError),\n            undefinedToTrue(remoteError),\n            type !== 'basic',\n            requestReplay,\n            sendLocalStack,\n        ]\n    }\n    if (log) return [true, true, true, true] as const\n    return []\n}\n\nexport const normalizeStrictOptions = (strict: NonNullable<AsyncCallOptions['strict']>) => {\n    if (!isBoolean(strict)) {\n        const { methodNotFound, unknownMessage } = strict\n        return [methodNotFound, unknownMessage] as const\n    }\n    return [strict, strict] as const\n}\n","export type * from './types.ts'\nexport type { _IgnoreResponse } from './core/notify.ts'\nexport { JSONSerialization, NoSerialization } from './utils/serialization.ts'\nexport { JSONEncoder, type JSONEncoderOptions } from './utils/encoder.ts'\nexport { notify } from './core/notify.ts'\nexport { batch } from './core/batch.ts'\n\nimport {\n    makeRequest,\n    ErrorResponseMapped,\n    makeSuccessResponse,\n    isJSONRPCObject,\n    defaultErrorMapper,\n    ErrorResponseMethodNotFound,\n    ErrorResponseInvalidRequest,\n    ErrorResponseParseError,\n} from './utils/jsonrpc.ts'\nimport {\n    removeStackHeader,\n    RecoverError,\n    makeHostedMessage,\n    Err_Cannot_call_method_starts_with_rpc_dot_directly,\n    Err_Then_is_accessed_on_local_implementation_Please_explicitly_mark_if_it_is_thenable_in_the_options,\n    onAbort,\n} from './utils/error.ts'\nimport { generateRandomID } from './utils/generateRandomID.ts'\nimport { normalizeStrictOptions, normalizeLogOptions } from './utils/normalizeOptions.ts'\nimport { AsyncCallIgnoreResponse, AsyncCallNotify, AsyncCallBatch } from './utils/internalSymbol.ts'\nimport type { BatchQueue } from './core/batch.ts'\nimport type {\n    CallbackBasedChannel,\n    EventBasedChannel,\n    AsyncCallOptions,\n    ConsoleInterface,\n    AsyncVersionOf,\n    Request,\n    Response,\n    SuccessResponse,\n    ErrorResponse,\n    IsomorphicEncoderFull,\n    IsomorphicEncoder,\n    Requests,\n    Responses,\n} from './types.ts'\nimport { apply, ERROR, isArray, isFunction, isObject, isString, Promise_resolve, undefined } from './utils/constants.ts'\n\n/**\n * Create a RPC server & client.\n *\n * @remarks\n * See {@link AsyncCallOptions}\n *\n * thisSideImplementation can be a Promise so you can write:\n *\n * ```ts\n * export const service = AsyncCall(typeof window === 'object' ? {} : import('./backend/service.js'), {})\n * ```\n *\n * @param thisSideImplementation - The implementation when this AsyncCall acts as a JSON RPC server. Can be a Promise.\n * @param options - {@link AsyncCallOptions}\n * @typeParam OtherSideImplementedFunctions - The type of the API that server expose. For any function on this interface, it will be converted to the async version.\n * @returns Same as the `OtherSideImplementedFunctions` type parameter, but every function in that interface becomes async and non-function value is removed. Method called \"then\" are also removed.\n * @public\n */\nexport function AsyncCall<OtherSideImplementedFunctions = {}>(\n    thisSideImplementation: null | undefined | object | Promise<object>,\n    options: AsyncCallOptions,\n): AsyncVersionOf<OtherSideImplementedFunctions> {\n    type Hint = 'request' | 'response' | undefined\n\n    let isThisSideImplementationPending = true\n    let resolvedThisSideImplementationValue: unknown\n    let rejectedThisSideImplementation: unknown\n\n    let resolvedChannel: EventBasedChannel | CallbackBasedChannel | undefined\n    let channelPromise: Promise<EventBasedChannel | CallbackBasedChannel> | undefined\n    // This promise should never fail\n    const awaitThisSideImplementation = async () => {\n        try {\n            resolvedThisSideImplementationValue = await thisSideImplementation\n        } catch (e) {\n            rejectedThisSideImplementation = e\n            console_error('AsyncCall failed to start', e)\n        } finally {\n            isThisSideImplementationPending = false\n        }\n    }\n    const onChannelResolved = (channel: EventBasedChannel | CallbackBasedChannel) => {\n        resolvedChannel = channel\n        if (isCallbackBasedChannel(channel)) {\n            channel.setup(\n                (data, hint) => rawMessageReceiver(data, hint).then(rawMessageSender),\n                (data, hint) => {\n                    let _ = hintedDecode(data, hint)\n\n                    if (isJSONRPCObject(_)) return true\n                    return Promise_resolve(_).then(isJSONRPCObject)\n                },\n            )\n        }\n        if (isEventBasedChannel(channel)) {\n            const m = channel\n            m.on &&\n                m.on((_, hint) =>\n                    rawMessageReceiver(_, hint)\n                        .then(rawMessageSender)\n                        .then((x) => x && m.send!(x)),\n                )\n        }\n        return channel\n    }\n\n    const {\n        serializer,\n        encoder,\n        key: deprecatedName,\n        name,\n        strict = true,\n        log = true,\n        parameterStructures: deprecatedParameterStructures,\n        parameterStructure,\n        preferLocalImplementation = false,\n        idGenerator = generateRandomID,\n        mapError,\n        logger,\n        channel,\n        thenable,\n        signal,\n        forceSignal,\n    } = options\n\n    // Note: we're not shorten this error message because it will be removed in the next major version.\n    if (serializer && encoder) throw new TypeError('Please remove serializer.')\n    if (name && deprecatedName) throw new TypeError('Please remove key.')\n    if (deprecatedParameterStructures && parameterStructure) throw new TypeError('Please remove parameterStructure.')\n    const paramStyle = deprecatedParameterStructures || parameterStructure || 'by-position'\n    const logKey = name || deprecatedName || 'rpc'\n\n    const throwIfAborted = () => {\n        signal && signal.throwIfAborted()\n        forceSignal && forceSignal.throwIfAborted()\n    }\n\n    const {\n        encode: encodeFromOption,\n        encodeRequest: encodeRequestFromOption,\n        encodeResponse: encodeResponseFromOption,\n        decode,\n        decodeRequest,\n        decodeResponse,\n    } = (encoder || {}) as IsomorphicEncoder & IsomorphicEncoderFull\n\n    const encodeRequest: (data: Requests | Responses) => any = encoder\n        ? (data) => apply(encodeRequestFromOption || encodeFromOption, encoder, [data])\n        : serializer\n          ? (data) => serializer.serialization(data)\n          : Object\n\n    const encodeResponse: (data: Requests | Responses) => any = encoder\n        ? (data) => apply(encodeResponseFromOption || encodeFromOption, encoder, [data])\n        : serializer\n          ? (data) => serializer.serialization(data)\n          : Object\n\n    const hintedDecode: (data: unknown, hint: Hint) => unknown = encoder\n        ? (data, hint) =>\n              hint == 'request'\n                  ? apply(decodeRequest || decode, encoder, [data])\n                  : hint == 'response'\n                    ? apply(decodeResponse || decode, encoder, [data])\n                    : apply(decode, encoder, [data])\n        : serializer\n          ? (data) => serializer.deserialization(data)\n          : Object\n\n    if (thisSideImplementation instanceof Promise) awaitThisSideImplementation()\n    else {\n        resolvedThisSideImplementationValue = thisSideImplementation\n        isThisSideImplementationPending = false\n    }\n\n    const [banMethodNotFound, banUnknownMessage] = normalizeStrictOptions(strict)\n    const [log_beCalled, log_localError, log_remoteError, log_pretty, log_requestReplay, log_sendLocalStack] =\n        normalizeLogOptions(log)\n    const {\n        log: console_log,\n        error: console_error = console_log,\n        debug: console_debug = console_log,\n        groupCollapsed: console_groupCollapsed = console_log,\n        groupEnd: console_groupEnd = console_log,\n        warn: console_warn = console_log,\n    } = (logger || console) as ConsoleInterface\n    type PromiseParam = [resolve: (value?: any) => void, reject: (reason?: any) => void, stack?: string]\n    const requestContext = new Map<string | number, PromiseParam>()\n\n    onAbort(forceSignal, () => {\n        requestContext.forEach((x) => x[1](forceSignal!.reason))\n        requestContext.clear()\n    })\n\n    const onRequest = async (data: Request): Promise<Response | undefined> => {\n        if ((signal && signal.aborted) || (forceSignal && forceSignal.aborted))\n            return makeErrorObject((signal && signal.reason) || (forceSignal && forceSignal.reason), '', data)\n        if (isThisSideImplementationPending) await awaitThisSideImplementation()\n        // TODO: in next major version we should not send this message since it might contain sensitive info.\n        else if (rejectedThisSideImplementation) return makeErrorObject(rejectedThisSideImplementation, '', data)\n        let frameworkStack: string = ''\n        try {\n            const { params, method, id: req_id, remoteStack } = data\n            // ? We're mapping any method starts with 'rpc.' to a Symbol.for\n            const key = (method.startsWith('rpc.') ? Symbol.for(method) : method) as keyof object\n            const executor: unknown = resolvedThisSideImplementationValue && resolvedThisSideImplementationValue[key]\n            if (!isFunction(executor)) {\n                if (!banMethodNotFound) {\n                    if (log_localError) console_debug('Missing method', key, data)\n                    return\n                } else return ErrorResponseMethodNotFound(req_id)\n            }\n            const args = isArray(params) ? params : [params]\n            frameworkStack = removeStackHeader(new Error().stack)\n            const promise = new Promise((resolve) =>\n                resolve(apply(executor, resolvedThisSideImplementationValue, args)),\n            )\n            if (log_beCalled) {\n                if (log_pretty) {\n                    const logArgs: unknown[] = [\n                        `${logKey}.%c${method}%c(${args.map(() => '%o').join(', ')}%c)\\n%o %c@${req_id}`,\n                        'color:#d2c057',\n                        '',\n                        ...args,\n                        '',\n                        promise,\n                        'color:gray;font-style:italic;',\n                    ]\n                    if (log_requestReplay) {\n                        const replay = () => {\n                            debugger\n                            return apply(executor, resolvedThisSideImplementationValue, args)\n                        }\n                        // this function will be logged, keep it short.\n                        // Do not inline it, it's hard to keep it in a single line after build step.\n                        logArgs.push(() => replay())\n                    }\n                    if (remoteStack) {\n                        console_groupCollapsed(...logArgs)\n                        console_log(remoteStack)\n                        console_groupEnd()\n                    } else console_log(...logArgs)\n                } else console_log(`${logKey}.${method}(${[...args].toString()}) @${req_id}`)\n            }\n            const result = await promise\n            if (result === AsyncCallIgnoreResponse) return\n            return makeSuccessResponse(req_id, result)\n        } catch (e) {\n            return makeErrorObject(e, frameworkStack, data)\n        }\n    }\n    const onResponse = async (data: Response): Promise<void> => {\n        let errorMessage = '',\n            remoteErrorStack = '',\n            errorCode = 0,\n            errorType = ERROR\n        if ('error' in data) {\n            const e = data.error\n            errorMessage = e.message\n            errorCode = e.code\n            const detail = e.data\n\n            if (isObject(detail) && 'stack' in detail && isString(detail.stack)) remoteErrorStack = detail.stack\n            else remoteErrorStack = '<remote stack not available>'\n\n            if (isObject(detail) && 'type' in detail && isString(detail.type)) errorType = detail.type\n            else errorType = ERROR\n\n            if (log_remoteError)\n                log_pretty\n                    ? console_error(\n                          `${errorType}: ${errorMessage}(${errorCode}) %c@${data.id}\\n%c${remoteErrorStack}`,\n                          'color: gray',\n                          '',\n                      )\n                    : console_error(`${errorType}: ${errorMessage}(${errorCode}) @${data.id}\\n${remoteErrorStack}`)\n        }\n        const { id } = data\n        if (id === null || id === undefined || !requestContext.has(id)) return\n        const [resolve, reject, localErrorStack = ''] = requestContext.get(id)!\n        requestContext.delete(id)\n        if ('error' in data) {\n            reject(\n                // TODO: add a hook to customize this\n                RecoverError(\n                    errorType,\n                    errorMessage,\n                    errorCode,\n                    // ? We use \\u0430 which looks like \"a\" to prevent browser think \"at AsyncCall\" is a real stack\n                    remoteErrorStack + '\\n    \\u0430t AsyncCall (rpc) \\n' + localErrorStack,\n                ),\n            )\n        } else {\n            resolve(data.result)\n        }\n        return\n    }\n    const rawMessageReceiver = async (\n        _: unknown,\n        hint: Hint,\n    ): Promise<undefined | Response | (Response | undefined)[]> => {\n        let data: unknown\n        let result: Response | undefined = undefined\n        try {\n            data = await hintedDecode(_, hint)\n            if (isJSONRPCObject(data)) {\n                return (result = await handleSingleMessage(data))\n            } else if (isArray(data) && data.every(isJSONRPCObject) && data.length !== 0) {\n                return Promise.all(data.map(handleSingleMessage))\n            } else {\n                if (banUnknownMessage) {\n                    let id = (data as any).id\n                    if (id === undefined) id = null\n                    return ErrorResponseInvalidRequest(id)\n                } else {\n                    // ? Ignore this message. The message channel maybe also used to transfer other message too.\n                    return undefined\n                }\n            }\n        } catch (e) {\n            if (log_localError) console_error(e, data, result)\n            let stack: string | undefined\n            try {\n                stack = '' + (e as any).stack\n            } catch {}\n            return ErrorResponseParseError(e, mapError || defaultErrorMapper(stack))\n        }\n    }\n    const rawMessageSender = async (res: undefined | Response | (Response | undefined)[]) => {\n        if (!res) return\n        if (isArray(res)) {\n            const reply = res.filter((x): x is Response => (x && 'id' in x) as boolean)\n            if (reply.length === 0) return\n            return encodeResponse(reply)\n        } else {\n            return encodeResponse(res)\n        }\n    }\n\n    if (channel instanceof Promise) channelPromise = channel.then(onChannelResolved)\n    else onChannelResolved(channel)\n\n    const makeErrorObject = (e: any, frameworkStack: string, data: Request) => {\n        if (isObject(e) && 'stack' in e)\n            e.stack = frameworkStack\n                .split('\\n')\n                .reduce((stack, fstack) => stack.replace(fstack + '\\n', ''), '' + e.stack)\n        if (log_localError) console_error(e)\n        return ErrorResponseMapped(data, e, mapError || defaultErrorMapper(log_sendLocalStack ? e.stack : undefined))\n    }\n\n    const sendPayload = async (payload: Requests | BatchQueue, removeQueueR?: true) => {\n        if (removeQueueR) payload = [...(payload as BatchQueue)]\n        const data = await encodeRequest(payload)\n        return (resolvedChannel || (await channelPromise))!.send!(data)\n    }\n    const rejectsQueue = (queue: BatchQueue, error: unknown) => {\n        for (const x of queue) {\n            if ('id' in x) {\n                const ctx = requestContext.get(x.id!)\n                ctx && ctx[1](error)\n            }\n        }\n    }\n    const handleSingleMessage = async (\n        data: SuccessResponse | ErrorResponse | Request,\n    ): Promise<SuccessResponse | ErrorResponse | undefined> => {\n        if ('method' in data) {\n            if ('id' in data) {\n                if (!forceSignal) return onRequest(data)\n                return new Promise((resolve, reject) => {\n                    const handleForceAbort = () => resolve(makeErrorObject(forceSignal.reason, '', data))\n                    onRequest(data)\n                        .then(resolve, reject)\n                        .finally(() => forceSignal.removeEventListener('abort', handleForceAbort))\n                    onAbort(forceSignal, handleForceAbort)\n                })\n            }\n            onRequest(data).catch(() => {})\n            return // Skip response for notifications\n        }\n        return onResponse(data) as Promise<undefined>\n    }\n    const call = (method: string | symbol, args: unknown[], stack: string | undefined, notify = false) => {\n        return new Promise<void>((resolve, reject) => {\n            throwIfAborted()\n            let queue: BatchQueue | undefined = undefined\n            if (method === AsyncCallBatch) {\n                queue = args.shift() as any\n                method = args.shift() as any\n            }\n            if (typeof method === 'symbol') {\n                const RPCInternalMethod: string = Symbol.keyFor(method) || (method as any).description\n                if (RPCInternalMethod) {\n                    if (RPCInternalMethod.startsWith('rpc.')) method = RPCInternalMethod\n                    else throw new TypeError('Not start with rpc.')\n                }\n            } else if (method.startsWith('rpc.')) {\n                throw makeHostedMessage(Err_Cannot_call_method_starts_with_rpc_dot_directly, new TypeError())\n            }\n\n            if (preferLocalImplementation && !isThisSideImplementationPending && isString(method)) {\n                const localImpl: unknown =\n                    resolvedThisSideImplementationValue && (resolvedThisSideImplementationValue as any)[method]\n                if (isFunction(localImpl)) return resolve(localImpl(...args))\n            }\n            const id = idGenerator()\n            stack = removeStackHeader(stack)\n            const param = paramStyle === 'by-name' && args.length === 1 && isObject(args[0]) ? args[0] : args\n            const request = makeRequest(\n                notify ? undefined : id,\n                method as string,\n                param,\n                log_sendLocalStack ? stack : undefined,\n            )\n            if (queue) {\n                queue.push(request)\n                if (!queue.r) queue.r = [() => sendPayload(queue!, true), (e) => rejectsQueue(queue!, e)]\n            } else sendPayload(request).catch(reject)\n            if (notify) return resolve()\n            requestContext.set(id, [resolve, reject, stack])\n        })\n    }\n    const getTrap = (_: any, method: string | symbol) => {\n        const f = {\n            // This function will be logged to the console so it must be 1 line\n            [method]: (..._: unknown[]) => call(method, _, new Error().stack),\n        }[method as any]!\n        const f2 = {\n            [method]: (..._: unknown[]) => call(method, _, new Error().stack, true),\n        }[method as any]!\n        // @ts-expect-error\n        f[AsyncCallNotify] = f2[AsyncCallNotify] = f2\n        isString(method) && Object.defineProperty(methodContainer, method, { value: f, configurable: true })\n        return f\n    }\n    const methodContainer: any = { __proto__: new Proxy({}, { get: getTrap }) }\n    if (thenable === false) methodContainer.then = undefined\n    else if (thenable === undefined) {\n        Object.defineProperty(methodContainer, 'then', {\n            configurable: true,\n            get() {\n                console_warn(\n                    makeHostedMessage(\n                        Err_Then_is_accessed_on_local_implementation_Please_explicitly_mark_if_it_is_thenable_in_the_options,\n                        new TypeError('RPC used as Promise: '),\n                    ),\n                )\n            },\n        })\n    }\n    return new Proxy(methodContainer, {\n        getPrototypeOf: () => null,\n        setPrototypeOf: (_, value) => value === null,\n        // some library will treat this object as a normal object and run algorithm steps in https://tc39.es/ecma262/#sec-ordinaryget\n        getOwnPropertyDescriptor(_, method) {\n            if (!(method in methodContainer)) getTrap(_, method) // trigger [[Get]]\n            return Object.getOwnPropertyDescriptor(methodContainer, method)\n        },\n    }) as AsyncVersionOf<OtherSideImplementedFunctions>\n}\n// Assume a console object in global if there is no custom logger provided\ndeclare const console: ConsoleInterface\n\nconst isEventBasedChannel = (x: EventBasedChannel | CallbackBasedChannel): x is EventBasedChannel =>\n    'send' in x && isFunction(x.send)\nconst isCallbackBasedChannel = (x: EventBasedChannel | CallbackBasedChannel): x is CallbackBasedChannel =>\n    'setup' in x && isFunction(x.setup)\n","import { isObject, undefined } from './constants.ts'\nimport type { Serialization } from '../types.ts'\n\n/**\n * Serialization implementation that do nothing\n * @remarks {@link Serialization}\n * @public\n * @deprecated Will be removed in next major version\n */\nexport const NoSerialization: Serialization = {\n    serialization(from) {\n        return from\n    },\n    deserialization(serialized) {\n        return serialized\n    },\n}\n\n/**\n * Create a serialization by JSON.parse/stringify\n *\n * @param replacerAndReceiver - Replacer and receiver of JSON.parse/stringify\n * @param space - Adds indentation, white space, and line break characters to the return-value JSON text to make it easier to read.\n * @param undefinedKeepingBehavior - How to keep \"undefined\" in result of SuccessResponse?\n *\n * If it is not handled properly, JSON.stringify will emit an invalid JSON RPC object.\n *\n * Options:\n * - `\"null\"`(**default**): convert it to null.\n * - `\"keep\"`: try to keep it by additional property \"undef\".\n * - `false`: Don't keep it, let it break.\n * @remarks {@link Serialization}\n * @public\n */\nexport const JSONSerialization = (\n    replacerAndReceiver: [((key: string, value: any) => any)?, ((key: string, value: any) => any)?] = [\n        undefined,\n        undefined,\n    ],\n    space?: string | number | undefined,\n    undefinedKeepingBehavior: 'keep' | 'null' | false = 'null',\n): Serialization => ({\n    serialization(from) {\n        if (undefinedKeepingBehavior && isObject(from) && 'result' in from && from.result === undefined) {\n            const alt = { ...from }\n            alt.result = null\n            if (undefinedKeepingBehavior === 'keep') (alt as any).undef = true\n            from = alt\n        }\n        return JSON.stringify(from, replacerAndReceiver[0], space)\n    },\n    deserialization(serialized) {\n        const result = JSON.parse(serialized as string, replacerAndReceiver[1])\n        if (\n            isObject(result) &&\n            'result' in result &&\n            result.result === null &&\n            'undef' in result &&\n            result.undef === true\n        ) {\n            result.result = undefined\n            delete result.undef\n        }\n        return result\n    },\n})\n","import { isString } from '../utils/constants.ts'\nimport { AsyncCallBatch, AsyncCallNotify } from '../utils/internalSymbol.ts'\nimport type { Request } from '../types.ts'\n/**\n * Wrap the AsyncCall instance to use batch call.\n * @param asyncCallInstance - The AsyncCall instance\n * @example\n * const [batched, send, drop] = batch(AsyncCall(...))\n * batched.call1() // pending\n * batched.call2() // pending\n * send() // send all pending requests\n * drop() // drop all pending requests\n * @returns It will return a tuple.\n *\n * The first item is the batched version of AsyncCall instance passed in.\n *\n * The second item is a function to send all pending requests.\n *\n * The third item is a function to drop and reject all pending requests.\n * @public\n */\n// TODO: use private field in the future.\nexport function batch<T extends object>(asyncCallInstance: T): [T, () => void, (error?: unknown) => void] {\n    const queue: BatchQueue = []\n    const getTrap = new Proxy(\n        {},\n        {\n            get(_, p) {\n                // @ts-expect-error\n                const f = (...args: any) => asyncCallInstance[AsyncCallBatch](queue, p, ...args)\n                // @ts-expect-error\n                f[AsyncCallNotify] = (...args: any) =>\n                    // @ts-expect-error\n                    asyncCallInstance[AsyncCallBatch][AsyncCallNotify](queue, p, ...args)\n                f[AsyncCallNotify][AsyncCallNotify] = f[AsyncCallNotify]\n                isString(p) && Object.defineProperty(methodContainer, p, { value: f, configurable: true })\n                return f\n            },\n        },\n    )\n    const methodContainer = { __proto__: getTrap } as any\n    return [\n        new Proxy(methodContainer, {\n            getPrototypeOf: () => null,\n            setPrototypeOf: (_, value) => value === null,\n        }),\n        () => {\n            queue.length && queue.r![0]()\n            queue.length = 0\n        },\n        (error = new Error('Aborted')) => {\n            queue.length && queue.r![1](error)\n            queue.length = 0\n        },\n    ]\n}\nexport type BatchQueue = Request[] & {\n    /** Request handler */\n    r?: [emit: () => void, reject: (error?: unknown) => void]\n}\n"],"names":["JSONEncoder","isString","x","isBoolean","isFunction","isObject","params","ERROR","undefined","Promise_resolve","Promise","resolve","isArray","Array","apply","Reflect","keepUndefined","replacer","reviver","space","encode","data","forEach","undefinedEncode","JSON","stringify","decode","encoded","parse","i","result","Default","AsyncCallIgnoreResponse","Symbol","for","AsyncCallNotify","AsyncCallBatch","notifyTrap","target","p","CustomError","Error","constructor","name","message","code","stack","Err_Cannot_call_method_starts_with_rpc_dot_directly","Err_Then_is_accessed_on_local_implementation_Please_explicitly_mark_if_it_is_thenable_in_the_options","Messages","makeHostedMessage","id","error","n","indexOf","errors","__proto__","EvalError","RangeError","ReferenceError","SyntaxError","TypeError","URIError","DOMExceptionHeader","RecoverError","type","E","startsWith","globalDOMException","slice","length","e","removeStackHeader","String","replace","DOMException","onAbort","signal","callback","addEventListener","once","makeRequest","method","remoteStack","jsonrpc","deleteUndefined","deleteFalsy","makeSuccessResponse","makeErrorResponse","Number","isNaN","Math","floor","ErrorResponseParseError","mapper","obj","ErrorResponseMapped","o","ErrorResponseInvalidRequest","ErrorResponseMethodNotFound","request","defaultErrorMapper","toString","ctor","eType","isJSONRPCObject","_default","val","v","key","generateRandomID","random","undefinedToTrue","normalizeLogOptions","log","beCalled","localError","remoteError","requestReplay","sendLocalStack","normalizeStrictOptions","strict","methodNotFound","unknownMessage","isEventBasedChannel","send","isCallbackBasedChannel","setup","thisSideImplementation","options","resolvedThisSideImplementationValue","rejectedThisSideImplementation","resolvedChannel","channelPromise","isThisSideImplementationPending","awaitThisSideImplementation","console_error","onChannelResolved","channel","hint","rawMessageReceiver","then","rawMessageSender","_","hintedDecode","m","on","serializer","encoder","deprecatedName","parameterStructures","deprecatedParameterStructures","parameterStructure","preferLocalImplementation","idGenerator","mapError","logger","thenable","forceSignal","paramStyle","logKey","throwIfAborted","encodeFromOption","encodeRequest","encodeRequestFromOption","encodeResponse","encodeResponseFromOption","decodeRequest","decodeResponse","serialization","Object","deserialization","banMethodNotFound","banUnknownMessage","log_beCalled","log_localError","log_remoteError","log_pretty","log_requestReplay","log_sendLocalStack","console_log","debug","console_debug","groupCollapsed","console_groupCollapsed","groupEnd","console_groupEnd","warn","console_warn","console","requestContext","Map","reason","clear","onRequest","aborted","makeErrorObject","frameworkStack","req_id","executor","args","promise","logArgs","map","join","replay","push","onResponse","errorMessage","remoteErrorStack","errorCode","errorType","detail","has","reject","localErrorStack","get","delete","handleSingleMessage","every","all","res","reply","filter","split","reduce","fstack","sendPayload","payload","removeQueueR","rejectsQueue","queue","ctx","handleForceAbort","finally","removeEventListener","catch","call","notify","shift","RPCInternalMethod","keyFor","description","localImpl","param","r","set","getTrap","f","f2","defineProperty","methodContainer","value","configurable","Proxy","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","replacerAndReceiver","undefinedKeepingBehavior","from","alt","undef","serialized","asyncCallInstance","instanceOrFnOnInstance"],"mappings":"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"}