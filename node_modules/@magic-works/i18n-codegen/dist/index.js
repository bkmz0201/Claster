import { i18NextParser } from './frameworks/i18next/parser/i18n-next.js';
import { GeneratorList, ParserList } from './json-schema.js';
import { GeneratorInput, ParserInput } from './type.js';
import { dirname, resolve } from 'node:path';
import { i18next_reactHooksGenerator } from './frameworks/i18next/index.js';
import { readFileSync, writeFileSync } from 'node:fs';
import { watch } from 'chokidar';
export * from './json-schema.js';
export function handleConfig(...[config, input, output]) {
    let { generator, parser } = config;
    if (typeof generator === 'string')
        generator = { type: generator };
    if (typeof parser === 'string')
        parser = { type: parser };
    const table = { [ParserList.i18next]: i18NextParser };
    const table2 = { [GeneratorList.i18next_reactHooks]: i18next_reactHooksGenerator };
    const result = table[parser.type](ParserInput.fromFileSystem(input, parser));
    const files = table2[generator.type](new GeneratorInput(result, input, output, generator));
    for (const [file, content] of files) {
        writeFileSync(file, content);
    }
}
const watchOptions = { atomic: true, awaitWriteFinish: true, ignoreInitial: false };
export function watchConfig(onError, ...[config, input, output]) {
    const watcher = watch(input, watchOptions);
    watcher.on('all', () => {
        try {
            handleConfig(config, input, output);
        }
        catch (e) {
            onError(e, config, input, output);
        }
    });
    return () => watcher.close();
}
export function runConfigList(watchMode, onError, configs) {
    if (watchMode) {
        const cancel = configs.map((x) => watchConfig(onError, ...x));
        // biome-ignore lint/complexity/noForEach: <explanation>
        return () => cancel.forEach((x) => x());
    }
    for (const x of configs) {
        try {
            handleConfig(...x);
        }
        catch (e) {
            onError(e, ...x);
        }
    }
    return;
}
export function runConfigFile(watchMode, onRecoverableError, configFilePath) {
    const config = JSON.parse(readFileSync(configFilePath, 'utf-8'));
    if (config.version !== 1)
        return;
    const base = dirname(configFilePath);
    const configList = config.list.map(({ input, output, ...rest }) => {
        const absoluteInputPath = resolve(base, input);
        const absoluteOutputPath = resolve(base, output);
        return [rest, absoluteInputPath, absoluteOutputPath];
    });
    return runConfigList(watchMode, onRecoverableError, configList);
}
export function runCli(argv, onError) {
    const config = resolve(process.cwd(), argv.config || './.i18n-codegen.json');
    if (argv.watch) {
        const watcher = watch(config, watchOptions);
        let r = runConfigFile(true, onError, config);
        watcher.addListener('all', () => {
            r();
            r = runConfigFile(true, onError, config);
        });
        return () => watcher.close();
    }
    return runConfigFile(false, onError, config);
}
//# sourceMappingURL=index.js.map