!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).AsyncCall={})}(this,function(e){"use strict";var r;let t=e=>"string"==typeof e,n=e=>"boolean"==typeof e,o=e=>"function"==typeof e,i=e=>"object"==typeof e&&null!==e,l="Error",a=void 0,s=e=>Promise.resolve(e),{isArray:c}=Array,{apply:u}=Reflect;function f({keepUndefined:e="null",replacer:r,reviver:t,space:n}={}){return{encode:t=>(e&&(c(t)?t.forEach(d):d(t)),JSON.stringify(t,r,n)),decode:e=>JSON.parse(e,t)}}let d=e=>{"result"in e&&e.result===a&&(e.result=null)};(r=f||(f={})).Default=r();let p="AsyncCall/",y=Symbol.for(p+"ignored"),h=Symbol.for(p+"notify"),g=Symbol.for(p+"batch"),b=(e,r)=>e[r][h];function m(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}class w extends Error{constructor(e,r,t,n){super(r),m(this,"name",void 0),m(this,"code",void 0),m(this,"stack",void 0),this.name=e,this.code=t,this.stack=n}}let E={},P={},k=[{},{},E,P],O=(e,r)=>{let t=k.indexOf(e);return r.message+=`Error ${t}: https://github.com/Jack-Works/async-call-rpc/wiki/Errors#`+t,r},$={__proto__:null,Error,EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError},v="DOMException:",S=(e,r,t,n)=>{try{let o;if(e.startsWith(v)&&(o=x())){let t=e.slice(v.length);return new o(r,t)}if(!(e in $))return new w(e,r,t,n);{let o=new $[e](r);return o.stack=n,o.code=t,o}}catch(o){return Error(`E${t} ${e}: ${r}
${n}`)}},j=e=>(e+"").replace(/^.+\n.+\n/,""),x=()=>{try{return DOMException}catch(e){}};function _(e,r){e&&e.addEventListener("abort",r,{once:!0})}let N=(e,r,t,n)=>{let o={jsonrpc:"2.0",id:e,method:r,params:t,remoteStack:n};return I(o,"id"),q(o,"remoteStack"),o},z=(e,r)=>{let t={jsonrpc:"2.0",id:e,result:r};return I(t,"id"),t},A=(e,r,t,n)=>{e===a&&(e=null),Number.isNaN(r=Math.floor(r))&&(r=-1);let o={jsonrpc:"2.0",id:e,error:{code:r,message:t,data:n}};return I(o.error,"data"),o},T=(e,r)=>{let t=J({},e,r),n=t.error;return n.code=-32700,n.message="Parse error",t},R=e=>A(e,-32600,"Invalid Request"),C=e=>A(e,-32601,"Method not found"),J=(e,r,t)=>{let{id:n}=e,{code:o,message:i,data:l}=t(r,e);return A(n,o,i,l)},M=(e="",r=-1)=>t=>{let n=W("",()=>t.message),i=W(l,(e=t.constructor)=>o(e)&&e.name),a=x();a&&t instanceof a&&(i=v+t.name);let s=typeof t;return("string"==s||"number"===s||"boolean"==s||"bigint"==s)&&(i=l,n=t+""),{code:r,message:n,data:e?{stack:e,type:i}:{type:i}}},D=e=>{if(!i(e)||!("jsonrpc"in e)||"2.0"!==e.jsonrpc)return!1;if("params"in e){let r=e.params;if(!c(r)&&!i(r))return!1}return!0},W=(e,r)=>{try{let t=r();if(t===a)return e;return t+""}catch(r){return e}},I=(e,r)=>{e[r]===a&&delete e[r]},q=(e,r)=>{e[r]||delete e[r]},L=()=>Math.random().toString(36).slice(2),F=e=>void 0===e||e,U=e=>{if("all"===e)return[!0,!0,!0,!0,!0,!0];if(!n(e)){let{beCalled:r,localError:t,remoteError:n,type:o,requestReplay:i,sendLocalStack:l}=e;return[F(r),F(t),F(n),"basic"!==o,i,l]}return e?[!0,!0,!0,!0]:[]},B=e=>{if(!n(e)){let{methodNotFound:r,unknownMessage:t}=e;return[r,t]}return[e,e]},G=e=>"send"in e&&o(e.send),H=e=>"setup"in e&&o(e.setup);e.AsyncCall=function(e,r){let n,f,d,p,b=!0,m=async()=>{try{n=await e}catch(e){f=e,ek("AsyncCall failed to start",e)}finally{b=!1}},w=e=>(d=e,H(e)&&e.setup((e,r)=>eN(e,r).then(ez),(e,r)=>{let t=ed(e,r);return!!D(t)||s(t).then(D)}),G(e)&&e.on&&e.on((r,t)=>eN(r,t).then(ez).then(r=>r&&e.send(r))),e),{serializer:k,encoder:$,key:v,name:x,strict:A=!0,log:W=!0,parameterStructures:I,parameterStructure:q,preferLocalImplementation:F=!1,idGenerator:K=L,mapError:Q,logger:V,channel:X,thenable:Y,signal:Z,forceSignal:ee}=r;if(k&&$)throw TypeError("Please remove serializer.");if(x&&v)throw TypeError("Please remove key.");if(I&&q)throw TypeError("Please remove parameterStructure.");let er=I||q||"by-position",et=x||v||"rpc",en=()=>{Z&&Z.throwIfAborted(),ee&&ee.throwIfAborted()},{encode:eo,encodeRequest:ei,encodeResponse:el,decode:ea,decodeRequest:es,decodeResponse:ec}=$||{},eu=$?e=>u(ei||eo,$,[e]):k?e=>k.serialization(e):Object,ef=$?e=>u(el||eo,$,[e]):k?e=>k.serialization(e):Object,ed=$?(e,r)=>"request"==r?u(es||ea,$,[e]):"response"==r?u(ec||ea,$,[e]):u(ea,$,[e]):k?e=>k.deserialization(e):Object;e instanceof Promise?m():(n=e,b=!1);let[ep,ey]=B(A),[eh,eg,eb,em,ew,eE]=U(W),{log:eP,error:ek=eP,debug:eO=eP,groupCollapsed:e$=eP,groupEnd:ev=eP,warn:eS=eP}=V||console,ej=new Map;_(ee,()=>{ej.forEach(e=>e[1](ee.reason)),ej.clear()});let ex=async e=>{if(Z&&Z.aborted||ee&&ee.aborted)return eA(Z&&Z.reason||ee&&ee.reason,"",e);if(b)await m();else if(f)return eA(f,"",e);let r="";try{let{params:t,method:i,id:l,remoteStack:a}=e,s=i.startsWith("rpc.")?Symbol.for(i):i,f=n&&n[s];if(!o(f)){if(ep)return C(l);eg&&eO("Missing method",s,e);return}let d=c(t)?t:[t];r=j(Error().stack);let p=new Promise(e=>e(u(f,n,d)));if(eh){if(em){let e=[`${et}.%c${i}%c(${d.map(()=>"%o").join(", ")}%c)
%o %c@${l}`,"color:#d2c057","",...d,"",p,"color:gray;font-style:italic;"];if(ew){let r=()=>{debugger;return u(f,n,d)};e.push(()=>r())}a?(e$(...e),eP(a),ev()):eP(...e)}else eP(`${et}.${i}(${[...d].toString()}) @${l}`)}let h=await p;if(h===y)return;return z(l,h)}catch(t){return eA(t,r,e)}},e_=async e=>{let r="",n="",o=0,s=l;if("error"in e){let a=e.error;r=a.message,o=a.code;let c=a.data;n=i(c)&&"stack"in c&&t(c.stack)?c.stack:"<remote stack not available>",s=i(c)&&"type"in c&&t(c.type)?c.type:l,eb&&(em?ek(`${s}: ${r}(${o}) %c@${e.id}
%c${n}`,"color: gray",""):ek(`${s}: ${r}(${o}) @${e.id}
${n}`))}let{id:c}=e;if(null===c||c===a||!ej.has(c))return;let[u,f,d=""]=ej.get(c);ej.delete(c),"error"in e?f(S(s,r,o,n+"\n    Ð°t AsyncCall (rpc) \n"+d)):u(e.result)},eN=async(e,r)=>{let t;let n=a;try{if(t=await ed(e,r),D(t))return n=await eC(t);if(c(t)&&t.every(D)&&0!==t.length)return Promise.all(t.map(eC));if(!ey)return a;{let e=t.id;return e===a&&(e=null),R(e)}}catch(r){let e;eg&&ek(r,t,n);try{e=""+r.stack}catch(e){}return T(r,Q||M(e))}},ez=async e=>{if(e){if(!c(e))return ef(e);{let r=e.filter(e=>e&&"id"in e);if(0===r.length)return;return ef(r)}}};X instanceof Promise?p=X.then(w):w(X);let eA=(e,r,t)=>(i(e)&&"stack"in e&&(e.stack=r.split("\n").reduce((e,r)=>e.replace(r+"\n",""),""+e.stack)),eg&&ek(e),J(t,e,Q||M(eE?e.stack:a))),eT=async(e,r)=>{r&&(e=[...e]);let t=await eu(e);return(d||await p).send(t)},eR=(e,r)=>{for(let t of e)if("id"in t){let e=ej.get(t.id);e&&e[1](r)}},eC=async e=>"method"in e?"id"in e?ee?new Promise((r,t)=>{let n=()=>r(eA(ee.reason,"",e));ex(e).then(r,t).finally(()=>ee.removeEventListener("abort",n)),_(ee,n)}):ex(e):void ex(e).catch(()=>{}):e_(e),eJ=(e,r,l,s=!1)=>new Promise((c,u)=>{en();let f=a;if(e===g&&(f=r.shift(),e=r.shift()),"symbol"==typeof e){let r=Symbol.keyFor(e)||e.description;if(r){if(r.startsWith("rpc."))e=r;else throw TypeError("Not start with rpc.")}}else if(e.startsWith("rpc."))throw O(E,TypeError());if(F&&!b&&t(e)){let t=n&&n[e];if(o(t))return c(t(...r))}let d=K();l=j(l);let p="by-name"===er&&1===r.length&&i(r[0])?r[0]:r,y=N(s?a:d,e,p,eE?l:a);if(f?(f.push(y),f.r||(f.r=[()=>eT(f,!0),e=>eR(f,e)])):eT(y).catch(u),s)return c();ej.set(d,[c,u,l])}),eM=(e,r)=>{let n={[r]:(...e)=>eJ(r,e,Error().stack)}[r],o={[r]:(...e)=>eJ(r,e,Error().stack,!0)}[r];return n[h]=o[h]=o,t(r)&&Object.defineProperty(eD,r,{value:n,configurable:!0}),n},eD={__proto__:new Proxy({},{get:eM})};return!1===Y?eD.then=a:Y===a&&Object.defineProperty(eD,"then",{configurable:!0,get(){eS(O(P,TypeError("RPC used as Promise: ")))}}),new Proxy(eD,{getPrototypeOf:()=>null,setPrototypeOf:(e,r)=>null===r,getOwnPropertyDescriptor:(e,r)=>(r in eD||eM(e,r),Object.getOwnPropertyDescriptor(eD,r))})},e.JSONEncoder=f,e.JSONSerialization=(e=[a,a],r,t="null")=>({serialization(n){if(t&&i(n)&&"result"in n&&n.result===a){let e={...n};e.result=null,"keep"===t&&(e.undef=!0),n=e}return JSON.stringify(n,e[0],r)},deserialization(r){let t=JSON.parse(r,e[1]);return i(t)&&"result"in t&&null===t.result&&"undef"in t&&!0===t.undef&&(t.result=a,delete t.undef),t}}),e.NoSerialization={serialization:e=>e,deserialization:e=>e},e.batch=function(e){let r=[],n={__proto__:new Proxy({},{get(o,i){let l=(...t)=>e[g](r,i,...t);return l[h]=(...t)=>e[g][h](r,i,...t),l[h][h]=l[h],t(i)&&Object.defineProperty(n,i,{value:l,configurable:!0}),l}})};return[new Proxy(n,{getPrototypeOf:()=>null,setPrototypeOf:(e,r)=>null===r}),()=>{r.length&&r.r[0](),r.length=0},(e=Error("Aborted"))=>{r.length&&r.r[1](e),r.length=0}]},e.notify=function(e){return o(e)?e[h]:new Proxy(e,{get:b})}});
//# sourceMappingURL=base.min.js.map
